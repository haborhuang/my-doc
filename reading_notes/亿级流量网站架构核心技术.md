# 高并发原则

无状态、拆分、服务化、消息队列、数据异构、缓存

## 数据异构

1.1高并发原则中提到 数据异构 或 数据闭环 的概念。

通常分为两种方式：
* 查询维度异构。如按订单号分库分表后，按商家维度和用户维度查询就变得复杂。此时可使用异构数据存储映射关系。也可考虑冗余部分数据以提升查询效率。
* 聚合数据异构。如商品详情页，数据源会很多，影响稳定性的因素增多。可考虑使用MQ接收数据变更，然后使用KV存储保存。


## 缓存

缓存对于读取服务来说是抗流量银弹。

### 浏览器端缓存

对响应头设置Expires、Cache-control等，适合实时性要求不高的数据。

#### 浏览器端强缓存机制

通过Expires、Cache-control response header可以设置浏览器端强缓存，浏览器在有效期内再次访问相同资源时直接读取缓存。

Expires通过GMT时间格式指定过期时间。Cache-control的max-age用来指定过期的秒数。

### 接入层缓存

可考虑在接入层Nginx使用缓存。对指定参数进行一致性哈希，保证相同数据的请求落在同一节点。

# 高可用原则

降级、限流、切流量、可回滚

## 降级

通过配置中心进行降级开关推送到各应用。如有Nginx做代理，可考虑在Nginx中处理降级。

## 切流量

* DNS 切换机房入口
* HTTP DNS。客户端分配流量入口。
* LVS/HaProxy 切换接入层
* Nginx 切换应用层

# 限流

## 算法

令牌桶：固定速率添加令牌，能获取到令牌时处理资源，获取不到时等待或拒绝。
漏桶：固定速率流出水滴（对应资源），桶满时等待或拒绝。
计数器。

## 应用级限流

如并发数、连接数、请求数等。

## 分布式限流

主要解决业务限流。

Redis+Lua的实现原子访问资源或配额，加上expire功能可实现时间窗口内的限流。

## 接入层限流

Nginx自带两个模块：
* 连接数限流 ngx_http_limit_conn_module
* 基于漏桶算法的请求限流 ngx_http_limit_req_module