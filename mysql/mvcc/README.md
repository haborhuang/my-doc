MVCC，全称Multi-Version Concurrency Control，即多版本并发控制。MVCC是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存。

MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读

带来的好处：
* 读写操作互不阻塞，提高并发读写性能。
* 解决脏读、不可重复读等并发事务问题。

# 快照读
* 当前读。读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。如select lock in share mode(共享锁)、select for update、update、insert、delete(排他锁)这些操作都是一种当前读。
* 快照读。快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本。如select操作就是快照读。
  * 快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。
  * 基于MVCC概念实现。

MVCC是一种概念，维护数据多版本，使得一些场景下读写不冲突。快照读是基于MVCC概念而实现的非阻塞读功能。当前读是悲观锁的一种具体实现。

# 实现原理

## 隐藏字段

每行记录都会有以下隐藏字段：
* DB_TRX_ID。6字节，最近修改(修改/插入)事务ID。
* DB_ROLL_PTR。7字节，回滚指针，指向这条记录的上一个版本。
* DB_ROW_ID。6字节，隐含的自增ID（隐藏主键），如果数据表没有主键，InnoDB会自动以DB_ROW_ID产生一个聚簇索引
* 删除flag。删除行的逻辑标记。

## undo log

分为insert和update两种：
* insert undo log。insert时产生，只在事务回滚时需要，并且在事务提交后可以被立即丢弃。
* update undo log。update或delete时产生，回滚和快照读时都会使用。不被使用时会被purge线程清除。

undo log相当于对数据修改的版本记录链表，表头为最新的旧记录。

## Read View

是快照读某条记录时产生的视图，用来控制当前事务可见的该记录版本。

三个属性：
* 生成时，活跃中的事务id列表。
* up_limit_id，活跃事务中最小的事务id。
* low_limit_id，未分配的下一个事务id。

可见性算法：
* 用记录的DB_TRX_ID与Read View 进行可见性比较，如可见则返回当前版本内容。
* 如不可见，则循环对undo log中的记录进行比较。直到找到可见版本，或遍历完。

可见性比较算法为：
* DB_TRX_ID < up_limit_id，当前版本数据在当前事务前提交，可见。否则进行下一个判断。
* DB_TRX_ID >= low_limit_id，当前版本数据在当前事务后提交，不可见。否则进入下一个判断。
* DB_TRX_ID 属于 活跃中的事务id列表，当前版本数据尚未提交，不可见。否则可见。

### 创建时机

RR级别下，事务中的第一次快照读会创建Read View，后续快照读使用同一Read View。

RC级别每次快照读都会创建Read View。因此可以看到其他事务提交的数据。